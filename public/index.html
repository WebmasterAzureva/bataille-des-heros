<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è Bataille des H√©ros</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Roboto:wght@400;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=1920') center/cover fixed;
            min-height: 100vh;
            color: white;
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(10,10,30,0.7) 0%, rgba(20,20,40,0.8) 50%, rgba(10,10,30,0.9) 100%);
            pointer-events: none;
        }
        
        h1, h2, .title-text { font-family: 'Cinzel', serif; }
        
        /* LOBBY */
        .lobby { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .lobby.hidden { display: none; }
        .lobby-title { font-size: 3em; color: #f1c40f; text-shadow: 0 0 30px rgba(241,196,15,0.5), 0 4px 8px rgba(0,0,0,0.8); margin-bottom: 30px; }
        .lobby-box { background: linear-gradient(135deg, rgba(40,30,20,0.95), rgba(20,15,10,0.98)); padding: 35px; border-radius: 15px; border: 3px solid #8b7355; text-align: center; min-width: 380px; }
        .lobby-btn { display: block; width: 100%; padding: 16px 25px; margin: 12px 0; font-size: 1.1em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-family: 'Cinzel', serif; text-transform: uppercase; letter-spacing: 2px; }
        .lobby-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn-create { background: linear-gradient(135deg, #8b4513, #cd853f); color: white; border: 2px solid #daa520; }
        .btn-join { background: linear-gradient(135deg, #2e4a2e, #4a7c4a); color: white; border: 2px solid #6b8e6b; }
        .room-code-input { width: 100%; padding: 14px; font-size: 1.6em; text-align: center; border: 3px solid #8b7355; border-radius: 8px; background: rgba(0,0,0,0.5); color: #f1c40f; margin: 12px 0; text-transform: uppercase; letter-spacing: 8px; font-family: 'Cinzel', serif; }
        .room-code-display { font-size: 2.5em; color: #f1c40f; letter-spacing: 10px; margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 8px; border: 2px solid #8b7355; }
        .waiting-text { color: #aaa; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* GAME */
        .game-container { position: relative; z-index: 10; width: 100vw; height: 100vh; display: none; }
        .game-container.active { display: block; }
        
        /* TOP BAR */
        .top-bar { position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: linear-gradient(180deg, rgba(30,25,20,0.95), rgba(20,15,10,0.8)); border-bottom: 3px solid #5a4a3a; }
        .player-stats { display: flex; align-items: center; gap: 15px; }
        .player-stats.opponent { flex-direction: row-reverse; }
        .player-name-bar { font-family: 'Cinzel', serif; font-size: 1em; font-weight: bold; padding: 8px 20px; background: linear-gradient(135deg, #3a3a5a, #2a2a4a); border-radius: 5px; border: 2px solid #5a5a7a; }
        .player-name-bar.me { border-color: #4a7c4a; background: linear-gradient(135deg, #2a4a2a, #1a3a1a); }
        .player-name-bar.opp { border-color: #7c4a4a; background: linear-gradient(135deg, #4a2a2a, #3a1a1a); }
        .resource-orb { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9em; border: 3px solid; background: radial-gradient(circle at 30% 30%, #4fc3f7, #0288d1); border-color: #29b6f6; }
        
        /* END TURN */
        .end-turn-btn { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); width: 90px; height: 90px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ff6b35, #c41e00); border: 4px solid #ffd700; cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.75em; font-weight: bold; color: white; text-transform: uppercase; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; }
        .end-turn-btn:hover { transform: translateX(-50%) scale(1.1); }
        .end-turn-btn:disabled { background: radial-gradient(circle at 30% 30%, #666, #333); border-color: #888; cursor: not-allowed; }
        .end-turn-btn.waiting { background: radial-gradient(circle at 30% 30%, #888, #555); }
        .timer-display { font-size: 1.4em; margin-top: 2px; }
        
        /* HERO */
        .hero-zone { position: absolute; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .hero-zone.me { left: 15px; }
        .hero-zone.opp { right: 15px; }
        .hero-card { width: 120px; height: 160px; border-radius: 10px; background: linear-gradient(135deg, #3a3a5a, #1a1a2a); border: 4px solid #8b7355; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .hero-zone.me .hero-card { border-color: #4a7c4a; background: linear-gradient(135deg, #2a4a3a, #1a2a2a); }
        .hero-zone.opp .hero-card { border-color: #7c4a4a; background: linear-gradient(135deg, #4a2a3a, #2a1a2a); }
        .hero-icon { font-size: 3.5em; }
        .hero-name { font-family: 'Cinzel', serif; font-size: 0.8em; margin-top: 5px; }
        .hero-hp { position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); background: radial-gradient(circle at 30% 30%, #e74c3c, #922b21); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em; font-weight: bold; border: 3px solid #f5b7b1; }
        .ready-indicator { position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; border-radius: 50%; background: #7f8c8d; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 0.6em; }
        .ready-indicator.ready { background: #27ae60; }
        .deck-stack { width: 85px; height: 115px; position: relative; margin-top: 15px; }
        .deck-card { position: absolute; width: 100%; height: 100%; border-radius: 6px; background: linear-gradient(135deg, #4a3a2a, #2a2015); border: 3px solid #8b7355; display: flex; align-items: center; justify-content: center; }
        .deck-card::after { content: 'üé¥'; font-size: 1.8em; opacity: 0.5; }
        .deck-card:nth-child(1) { top: 0; left: 0; }
        .deck-card:nth-child(2) { top: 2px; left: 2px; }
        .deck-card:nth-child(3) { top: 4px; left: 4px; }
        .deck-count-label { position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); font-size: 0.8em; color: #aaa; white-space: nowrap; }
        
        /* HAND */
        .hand-panel { position: absolute; left: 155px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 4px; padding: 8px 5px; background: linear-gradient(90deg, rgba(30,25,20,0.9), transparent); border-radius: 0 12px 12px 0; max-height: 85vh; overflow-y: auto; }
        .hand-card-wrapper { position: relative; width: 45px; height: 60px; transition: all 0.3s ease; cursor: pointer; }
        .hand-card-wrapper:hover { width: 115px; z-index: 100; margin: 8px 0; }
        .hand-card-wrapper .card { position: absolute; left: 0; top: 0; width: 95px; height: 125px; transform: scale(0.45); transform-origin: left center; transition: all 0.3s ease; }
        .hand-card-wrapper:hover .card { transform: scale(1); }
        .hand-card-wrapper.selected .card { transform: scale(1) translateX(15px); box-shadow: 0 0 25px rgba(241,196,15,0.8); }
        
        /* OPP HAND */
        .opponent-hand { position: absolute; right: 155px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 3px; padding: 8px 5px; background: linear-gradient(-90deg, rgba(30,25,20,0.9), transparent); border-radius: 12px 0 0 12px; }
        .opp-card-back { width: 40px; height: 55px; border-radius: 4px; background: linear-gradient(135deg, #4a3a2a, #2a2015); border: 2px solid #8b7355; display: flex; align-items: center; justify-content: center; font-size: 1em; opacity: 0.8; }
        
        /* BATTLEFIELD */
        .battlefield { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 40px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 15px; border: 2px solid rgba(139,115,85,0.3); }
        .battlefield-side { display: grid; grid-template-columns: repeat(2, 100px); grid-template-rows: repeat(4, 130px); gap: 6px; }
        .battlefield-side.opp { direction: rtl; }
        .battlefield-side.opp > * { direction: ltr; }
        .trap-column { display: flex; flex-direction: column; gap: 15px; justify-content: center; padding: 0 8px; }
        
        /* SLOTS */
        .card-slot { width: 100px; height: 130px; border: 2px solid rgba(255,255,255,0.15); border-radius: 6px; background: rgba(255,255,255,0.03); cursor: pointer; transition: all 0.3s; position: relative; }
        .card-slot:hover { border-color: rgba(241,196,15,0.6); background: rgba(241,196,15,0.1); }
        .card-slot.me-slot { border-color: rgba(74,124,74,0.4); }
        .card-slot.opp-slot { border-color: rgba(124,74,74,0.4); }
        .card-slot.has-card { border-color: transparent; background: transparent; }
        .card-slot.selected { border-color: #f1c40f !important; box-shadow: 0 0 20px rgba(241,196,15,0.8); }
        .card-slot.targetable { border-color: #e74c3c !important; animation: targetPulse 1s infinite; }
        @keyframes targetPulse { 0%, 100% { box-shadow: 0 0 8px rgba(231,76,60,0.5); } 50% { box-shadow: 0 0 25px rgba(231,76,60,0.9); } }
        
        .trap-slot { width: 50px; height: 50px; border: 2px dashed rgba(255,255,255,0.3); transform: rotate(45deg); cursor: pointer; transition: all 0.3s; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; }
        .trap-inner { transform: rotate(-45deg); font-size: 1.2em; }
        .trap-slot:hover { border-color: #f1c40f; background: rgba(241,196,15,0.2); }
        .trap-slot.me-trap { border-color: rgba(74,124,74,0.5); }
        .trap-slot.opp-trap { border-color: rgba(124,74,74,0.5); }
        .trap-slot.has-trap { border-style: solid; background: rgba(231,76,60,0.4); border-color: #e74c3c; }
        
        /* CARDS */
        .card { width: 96px; height: 126px; border-radius: 5px; position: relative; cursor: pointer; transition: all 0.2s; overflow: hidden; }
        .card:hover { z-index: 50; }
        .card-cost { position: absolute; top: 4px; left: 4px; width: 24px; height: 24px; background: radial-gradient(circle at 30% 30%, #4fc3f7, #0277bd); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; border: 2px solid #81d4fa; z-index: 5; }
        .card-art { width: 100%; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 2.2em; }
        .card.creature .card-art { background: linear-gradient(180deg, #2a3a5a, #151d2e); }
        .card.spell .card-art { background: linear-gradient(180deg, #5a2a6a, #2d1535); }
        .card.trap-card .card-art { background: linear-gradient(180deg, #6a2a2a, #351515); }
        .card-body { background: linear-gradient(180deg, #1a1a1a, #0d0d0d); padding: 4px; height: 66px; }
        .card-name { font-family: 'Cinzel', serif; font-size: 0.55em; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #f1c40f; }
        .card-abilities { display: flex; gap: 2px; justify-content: center; font-size: 0.7em; margin: 2px 0; }
        .card-stats { display: flex; justify-content: space-between; padding: 0 6px; margin-top: 4px; }
        .stat-badge { font-size: 0.8em; font-weight: bold; padding: 2px 8px; border-radius: 3px; min-width: 28px; text-align: center; }
        .stat-atk { background: linear-gradient(135deg, #c0392b, #96281b); border: 1px solid #e74c3c; }
        .stat-hp { background: linear-gradient(135deg, #27ae60, #1e8449); border: 1px solid #2ecc71; }
        .stat-hp.damaged { background: linear-gradient(135deg, #e74c3c, #c0392b); border-color: #f1948a; }
        .card.creature { border: 3px solid #3498db; }
        .card.spell { border: 3px solid #9b59b6; }
        .card.trap-card { border: 3px solid #e74c3c; }
        .card.just-played { opacity: 0.7; }
        .card.just-played::after { content: 'üí§'; position: absolute; top: 4px; right: 4px; font-size: 0.7em; }
        .card.can-attack { box-shadow: 0 0 15px rgba(231,76,60,0.8); }
        .card.moved::before { content: '‚úì'; position: absolute; top: 4px; right: 4px; font-size: 0.6em; background: #27ae60; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; }
        .card.unplayable { opacity: 0.4; filter: grayscale(70%); }
        
        /* UI */
        .selection-info { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); padding: 10px 25px; background: linear-gradient(135deg, rgba(155,89,182,0.9), rgba(125,60,152,0.9)); border-radius: 20px; border: 2px solid #bb8fce; font-size: 0.95em; display: none; z-index: 100; }
        .selection-info.active { display: block; }
        .log-toggle { position: absolute; bottom: 15px; right: 15px; width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #8b7355, #5a4a3a); border: 3px solid #daa520; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.3em; transition: all 0.3s; z-index: 100; }
        .log-toggle:hover { transform: scale(1.1); }
        .log-popup { position: absolute; bottom: 70px; right: 15px; width: 320px; max-height: 350px; background: linear-gradient(135deg, rgba(40,30,20,0.98), rgba(20,15,10,0.98)); border: 3px solid #8b7355; border-radius: 12px; padding: 12px; display: none; z-index: 100; }
        .log-popup.active { display: block; }
        .log-popup h3 { font-family: 'Cinzel', serif; color: #f1c40f; margin-bottom: 8px; text-align: center; font-size: 1em; }
        .log-content { max-height: 280px; overflow-y: auto; }
        .log-entry { padding: 4px 8px; margin-bottom: 2px; border-radius: 3px; font-size: 0.75em; }
        .log-phase { background: rgba(241,196,15,0.2); color: #f1c40f; }
        .log-action { background: rgba(52,152,219,0.2); color: #5dade2; }
        .log-damage { background: rgba(231,76,60,0.2); color: #ec7063; }
        .log-heal { background: rgba(46,204,113,0.2); color: #58d68d; }
        .log-trap { background: rgba(155,89,182,0.2); color: #bb8fce; }
        
        /* GAME OVER */
        .game-over { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .game-over.hidden { display: none; }
        .game-over-box { text-align: center; padding: 40px; background: linear-gradient(135deg, rgba(60,50,40,0.98), rgba(30,25,20,0.98)); border-radius: 15px; border: 4px solid #f1c40f; }
        .game-over-title { font-family: 'Cinzel', serif; font-size: 2.5em; color: #f1c40f; margin-bottom: 15px; }
        .game-over-result { font-size: 1.3em; margin-bottom: 25px; }
        .game-over-result.victory { color: #2ecc71; }
        .game-over-result.defeat { color: #e74c3c; }
        
        .floating-text { position: absolute; font-size: 1.3em; font-weight: bold; pointer-events: none; z-index: 200; animation: floatUp 1s ease-out forwards; text-shadow: 2px 2px 4px black; left: 50%; top: 50%; }
        .floating-text.damage { color: #e74c3c; }
        .floating-text.heal { color: #2ecc71; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-40px) scale(1.3); } }
    </style>
</head>
<body>
    <div class="lobby" id="lobby">
        <h1 class="lobby-title">‚öîÔ∏è Bataille des H√©ros</h1>
        <div class="lobby-box" id="lobby-menu">
            <h2 style="margin-bottom: 25px; color: #f1c40f;">Multijoueur</h2>
            <button class="lobby-btn btn-create" onclick="createRoom()">üéÆ Cr√©er une partie</button>
            <div style="margin: 18px 0; color: #666;">‚Äî ou ‚Äî</div>
            <input type="text" class="room-code-input" id="room-code-input" placeholder="CODE" maxlength="6">
            <button class="lobby-btn btn-join" onclick="joinRoom()">üö™ Rejoindre</button>
        </div>
        <div class="lobby-box hidden" id="lobby-waiting">
            <h2 style="color: #f1c40f; margin-bottom: 15px;">Partie cr√©√©e !</h2>
            <p style="color: #aaa; margin-bottom: 8px;">Partagez ce code :</p>
            <div class="room-code-display" id="room-code-display">------</div>
            <p class="waiting-text">‚è≥ En attente d'un adversaire...</p>
        </div>
    </div>

    <div class="game-container" id="game-container">
        <div class="top-bar">
            <div class="player-stats me">
                <div class="player-name-bar me">VOUS (J<span id="my-player-num">1</span>)</div>
                <div class="resource-orb" id="me-energy-orb">1</div>
            </div>
            <div class="player-stats opponent">
                <div class="player-name-bar opp">ADVERSAIRE</div>
                <div class="resource-orb" id="opp-energy-orb">1</div>
            </div>
        </div>
        
        <button class="end-turn-btn" id="end-turn-btn" onclick="toggleReady()">
            <span>Fin du</span><span>Tour</span><span class="timer-display" id="timer-display">90</span>
        </button>
        
        <div class="hero-zone me">
            <div class="hero-card">
                <div class="ready-indicator" id="me-ready"></div>
                <div class="hero-icon">üßô‚Äç‚ôÇÔ∏è</div>
                <div class="hero-name">Archimage</div>
                <div class="hero-hp" id="me-hp">20</div>
            </div>
            <div class="deck-stack">
                <div class="deck-card"></div><div class="deck-card"></div><div class="deck-card"></div>
                <div class="deck-count-label"><span id="me-deck">53</span> cartes</div>
            </div>
        </div>
        
        <div class="hero-zone opp">
            <div class="hero-card">
                <div class="ready-indicator" id="opp-ready"></div>
                <div class="hero-icon">‚öîÔ∏è</div>
                <div class="hero-name">Guerrier</div>
                <div class="hero-hp" id="opp-hp">20</div>
            </div>
            <div class="deck-stack">
                <div class="deck-card"></div><div class="deck-card"></div><div class="deck-card"></div>
                <div class="deck-count-label"><span id="opp-deck">53</span> cartes</div>
            </div>
        </div>
        
        <div class="hand-panel" id="hand-panel"></div>
        <div class="opponent-hand" id="opp-hand"></div>
        
        <div class="battlefield">
            <div class="battlefield-side me" id="bf-me"></div>
            <div class="trap-column" id="traps-me"></div>
            <div class="trap-column" id="traps-opp"></div>
            <div class="battlefield-side opp" id="bf-opp"></div>
        </div>
        
        <div class="selection-info" id="selection-info"><span id="selection-text"></span></div>
        <div class="log-toggle" onclick="toggleLog()">üìú</div>
        <div class="log-popup" id="log-popup">
            <h3>üìú Journal</h3>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>
    
    <div class="game-over hidden" id="game-over">
        <div class="game-over-box">
            <div class="game-over-title">üèÜ Partie Termin√©e</div>
            <div class="game-over-result" id="game-over-result">Victoire !</div>
            <button class="lobby-btn btn-create" onclick="location.reload()">üîÑ Nouvelle partie</button>
        </div>
    </div>

    <script>
        let socket, myPlayerNum = 0, gameState = null, selectedCard = null, selectedSlot = null, targetingMode = null;
        
        function initSocket() {
            socket = io();
            socket.on('gameStart', (state) => { gameState = state; document.getElementById('lobby').classList.add('hidden'); document.getElementById('game-container').classList.add('active'); initBattlefield(); updateUI(); log('üéÆ Partie lanc√©e !', 'phase'); });
            socket.on('gameStateUpdate', (state) => { gameState = state; updateUI(); });
            socket.on('timerUpdate', (time) => { if (gameState) gameState.timeLeft = time; updateTimer(time); });
            socket.on('phaseChange', (phase) => { if (gameState) gameState.phase = phase; updatePhase(phase); });
            socket.on('playerReady', (pNum) => { const isMe = pNum === myPlayerNum; document.getElementById(isMe ? 'me-ready' : 'opp-ready').classList.add('ready'); document.getElementById(isMe ? 'me-ready' : 'opp-ready').textContent = '‚úì'; log(`${isMe ? 'Vous √™tes' : 'Adversaire'} pr√™t`, 'action'); });
            socket.on('newTurn', (data) => { document.getElementById('me-ready').classList.remove('ready'); document.getElementById('opp-ready').classList.remove('ready'); document.getElementById('me-ready').textContent = ''; document.getElementById('opp-ready').textContent = ''; document.getElementById('end-turn-btn').classList.remove('waiting'); document.getElementById('end-turn-btn').disabled = false; document.getElementById('end-turn-btn').innerHTML = `<span>Fin du</span><span>Tour</span><span class="timer-display" id="timer-display">90</span>`; log(`üéÆ Tour ${data.turn} ‚Äî ‚ö°${data.maxEnergy}`, 'phase'); });
            socket.on('resolutionLog', (data) => log(data.msg, data.type));
            socket.on('spellEffect', (data) => { const slot = document.querySelector(`.card-slot[data-owner="${data.player === myPlayerNum ? 'me' : 'opp'}"][data-row="${data.row}"][data-col="${data.col}"]`); if (slot) floatText(slot, data.type === 'damage' ? `-${data.amount || 3}` : '+3', data.type); });
            socket.on('directDamage', (data) => { const el = document.getElementById(data.defender === myPlayerNum ? 'me-hp' : 'opp-hp'); el.style.transform = 'scale(1.3)'; el.style.background = 'radial-gradient(circle, #ff0000, #660000)'; setTimeout(() => { el.style.transform = ''; el.style.background = ''; }, 300); });
            socket.on('gameOver', (data) => { const won = data.winner === myPlayerNum; document.getElementById('game-over-result').textContent = won ? 'üéâ Victoire !' : 'üò¢ D√©faite'; document.getElementById('game-over-result').className = `game-over-result ${won ? 'victory' : 'defeat'}`; document.getElementById('game-over').classList.remove('hidden'); });
            socket.on('playerDisconnected', (pNum) => log(`‚ö†Ô∏è J${pNum} d√©connect√©`, 'damage'));
        }
        
        function createRoom() { socket.emit('createRoom', (res) => { if (res.success) { myPlayerNum = res.playerNum; document.getElementById('my-player-num').textContent = myPlayerNum; document.getElementById('room-code-display').textContent = res.code; document.getElementById('lobby-menu').classList.add('hidden'); document.getElementById('lobby-waiting').classList.remove('hidden'); } }); }
        function joinRoom() { const code = document.getElementById('room-code-input').value.trim(); if (!code) return; socket.emit('joinRoom', code, (res) => { if (res.success) { myPlayerNum = res.playerNum; document.getElementById('my-player-num').textContent = myPlayerNum; } else alert(res.error); }); }
        
        function initBattlefield() {
            const bfMe = document.getElementById('bf-me'); bfMe.innerHTML = '';
            for (let col = 1; col >= 0; col--) for (let row = 0; row < 4; row++) bfMe.appendChild(createSlot('me', row, col));
            const bfOpp = document.getElementById('bf-opp'); bfOpp.innerHTML = '';
            for (let col = 0; col <= 1; col++) for (let row = 0; row < 4; row++) bfOpp.appendChild(createSlot('opp', row, col));
            const trapsMe = document.getElementById('traps-me'); const trapsOpp = document.getElementById('traps-opp'); trapsMe.innerHTML = ''; trapsOpp.innerHTML = '';
            for (let i = 0; i < 4; i++) { trapsMe.appendChild(createTrapSlot('me', i)); trapsOpp.appendChild(createTrapSlot('opp', i)); }
        }
        
        function createSlot(owner, row, col) { const slot = document.createElement('div'); slot.className = `card-slot ${owner}-slot`; slot.dataset.owner = owner; slot.dataset.row = row; slot.dataset.col = col; slot.onclick = () => handleSlotClick(owner, row, col); return slot; }
        function createTrapSlot(owner, row) { const slot = document.createElement('div'); slot.className = `trap-slot ${owner}-trap`; slot.dataset.owner = owner; slot.dataset.trap = row; slot.innerHTML = '<span class="trap-inner">‚óá</span>'; slot.onclick = () => handleTrapClick(owner, row); return slot; }
        
        function updateUI() {
            if (!gameState) return;
            const me = gameState.me, opp = gameState.opponent;
            document.getElementById('me-hp').textContent = me.hp;
            document.getElementById('opp-hp').textContent = opp.hp;
            document.getElementById('me-energy-orb').textContent = `${me.energy}/${me.maxEnergy}`;
            document.getElementById('opp-energy-orb').textContent = `${opp.energy}/${opp.maxEnergy}`;
            document.getElementById('me-deck').textContent = me.deckCount;
            document.getElementById('opp-deck').textContent = opp.deckCount;
            updateField('me', me.field); updateField('opp', opp.field);
            updateTraps('me', me.traps); updateTraps('opp', opp.trapsCount);
            updateHand(me.hand, me.energy); updateOppHand(opp.handCount);
            if (me.ready) { document.getElementById('me-ready').classList.add('ready'); document.getElementById('me-ready').textContent = '‚úì'; document.getElementById('end-turn-btn').classList.add('waiting'); document.getElementById('end-turn-btn').innerHTML = `<span>En</span><span>attente</span><span class="timer-display" id="timer-display">${gameState.timeLeft}</span>`; }
            if (opp.ready) { document.getElementById('opp-ready').classList.add('ready'); document.getElementById('opp-ready').textContent = '‚úì'; }
        }
        
        function updateField(owner, field) { for (let r = 0; r < 4; r++) for (let c = 0; c < 2; c++) { const slot = document.querySelector(`.card-slot[data-owner="${owner}"][data-row="${r}"][data-col="${c}"]`); if (!slot) continue; slot.querySelector('.card')?.remove(); slot.classList.remove('has-card'); const card = field[r][c]; if (card) { slot.classList.add('has-card'); slot.appendChild(createCardEl(card, false)); } } }
        function updateTraps(owner, data) { if (owner === 'me') { data.forEach((trap, i) => { const slot = document.querySelector(`.trap-slot[data-owner="me"][data-trap="${i}"]`); if (slot) { slot.classList.toggle('has-trap', !!trap); slot.querySelector('.trap-inner').textContent = trap ? 'üí£' : '‚óá'; } }); } else { document.querySelectorAll('.trap-slot[data-owner="opp"]').forEach((slot, i) => { slot.classList.toggle('has-trap', i < data); slot.querySelector('.trap-inner').textContent = i < data ? '‚ùì' : '‚óá'; }); } }
        function updateHand(hand, energy) { const panel = document.getElementById('hand-panel'); panel.innerHTML = ''; hand.forEach((card, i) => { const wrapper = document.createElement('div'); wrapper.className = 'hand-card-wrapper'; if (card.cost > energy) wrapper.classList.add('unplayable'); const el = createCardEl(card, true); if (card.cost > energy) el.classList.add('unplayable'); wrapper.appendChild(el); wrapper.onclick = () => selectHandCard(i); panel.appendChild(wrapper); }); }
        function updateOppHand(count) { const panel = document.getElementById('opp-hand'); panel.innerHTML = ''; for (let i = 0; i < count; i++) { const card = document.createElement('div'); card.className = 'opp-card-back'; card.textContent = 'üé¥'; panel.appendChild(card); } }
        
        function createCardEl(card, inHand) { const el = document.createElement('div'); el.className = `card ${card.type === 'trap' ? 'trap-card' : card.type}`; if (!inHand && card.type === 'creature') { if (card.turnsOnField === 0 && !card.abilities?.includes('haste')) el.classList.add('just-played'); if (card.canAttack) el.classList.add('can-attack'); if (card.movedThisTurn) el.classList.add('moved'); } const icons = { fly: 'ü¶Ö', shooter: 'üéØ', haste: '‚ö°' }; const abilities = (card.abilities || []).map(a => icons[a] || '').join(' '); const hp = card.currentHp ?? card.hp; const hpClass = card.type === 'creature' && hp < card.hp ? 'damaged' : ''; el.innerHTML = `<div class="card-cost">${card.cost}</div><div class="card-art">${card.icon || '‚ùì'}</div><div class="card-body"><div class="card-name">${card.name}</div><div class="card-abilities">${abilities || (card.type === 'spell' ? (card.offensive ? '‚öîÔ∏è' : 'üõ°Ô∏è') : '')}</div><div class="card-stats">${card.atk !== undefined ? `<span class="stat-badge stat-atk">${card.atk}</span>` : ''}${card.damage ? `<span class="stat-badge stat-atk">${card.damage}</span>` : ''}${card.heal ? `<span class="stat-badge stat-hp">${card.heal}</span>` : ''}${card.type === 'creature' ? `<span class="stat-badge stat-hp ${hpClass}">${hp}</span>` : ''}</div></div>`; return el; }
        
        function updateTimer(time) { const el = document.getElementById('timer-display'); if (el) el.textContent = time; document.getElementById('end-turn-btn').style.animation = time <= 10 ? 'pulse 0.5s infinite' : ''; }
        function updatePhase(phase) { const btn = document.getElementById('end-turn-btn'); if (phase === 'resolution') { btn.disabled = true; btn.innerHTML = `<span>‚öîÔ∏è</span><span>Combat</span>`; } }
        
        function selectHandCard(i) { if (gameState.phase !== 'planning' || gameState.me.ready) return; clearSelections(); const card = gameState.me.hand[i]; if (card.cost > gameState.me.energy) return; selectedCard = { ...card, handIndex: i }; document.querySelectorAll('.hand-card-wrapper')[i]?.classList.add('selected'); if (card.type === 'spell') { targetingMode = 'spell'; document.querySelectorAll('.card-slot').forEach(s => s.classList.add('targetable')); showInfo(`üéØ ${card.name}: Cliquez cible`); } else if (card.type === 'creature') { showInfo(`üé¥ ${card.name}: Cliquez emplacement`); } else if (card.type === 'trap') { showInfo(`ü™§ ${card.name}: Cliquez pi√®ge`); } }
        function handleSlotClick(owner, row, col) { if (gameState.phase !== 'planning' || gameState.me.ready) return; if (targetingMode === 'spell' && selectedCard) { socket.emit('castSpell', { handIndex: selectedCard.handIndex, targetPlayer: owner === 'me' ? myPlayerNum : (myPlayerNum === 1 ? 2 : 1), row, col }); clearSelections(); return; } if (owner !== 'me') return; if (selectedCard && selectedCard.type === 'creature') { socket.emit('placeCard', { handIndex: selectedCard.handIndex, row, col }); clearSelections(); return; } const card = gameState.me.field[row][col]; if (selectedSlot) { socket.emit('moveCard', { fromRow: selectedSlot.row, fromCol: selectedSlot.col, toRow: row, toCol: col }); clearSelections(); } else if (card && !card.movedThisTurn) { selectedSlot = { row, col }; document.querySelector(`.card-slot[data-owner="me"][data-row="${row}"][data-col="${col}"]`)?.classList.add('selected'); showInfo(`üîÑ ${card.name}: Destination`); } }
        function handleTrapClick(owner, trapIndex) { if (gameState.phase !== 'planning' || gameState.me.ready || owner !== 'me') return; if (selectedCard && selectedCard.type === 'trap') { socket.emit('placeTrap', { handIndex: selectedCard.handIndex, trapIndex }); clearSelections(); } }
        function toggleReady() { if (gameState.phase !== 'planning' || gameState.me.ready) return; socket.emit('ready'); }
        function clearSelections() { selectedCard = null; selectedSlot = null; targetingMode = null; document.querySelectorAll('.hand-card-wrapper, .card-slot').forEach(e => e.classList.remove('selected', 'targetable')); document.getElementById('selection-info').classList.remove('active'); }
        function showInfo(text) { document.getElementById('selection-text').textContent = text; document.getElementById('selection-info').classList.add('active'); }
        function floatText(slot, text, type) { const el = document.createElement('div'); el.className = `floating-text ${type}`; el.textContent = text; slot.appendChild(el); setTimeout(() => el.remove(), 1000); }
        function toggleLog() { document.getElementById('log-popup').classList.toggle('active'); }
        function log(msg, type = 'action') { const el = document.createElement('div'); el.className = `log-entry log-${type}`; el.textContent = msg; const c = document.getElementById('log-content'); c.appendChild(el); c.scrollTop = c.scrollHeight; }
        document.addEventListener('DOMContentLoaded', () => { initSocket(); document.getElementById('room-code-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') joinRoom(); }); });
    </script>
</body>
</html>
